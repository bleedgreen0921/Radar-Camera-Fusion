# 卡尔曼滤波

### 1.1 基本概念与假设

**适用系统**：

- 线性动态系统
- 高斯白噪声
- 离散时间系统

**核心假设**：

1. **线性性**：状态转移和观测都是线性的
2. **高斯性**：过程噪声和观测噪声均为高斯分布
3. **马尔可夫性**：当前状态只与前一状态有关

### 1.2 数学模型

**状态空间模型**：
$$
x_k = F_k x_{k-1} + B_k u_k + w_k
$$

$$
z_k = H_k x_k + v_k
$$

```
状态方程：x_k = F_k * x_{k-1} + B_k * u_k + w_k
观测方程：z_k = H_k * x_k + v_k

其中：
x_k：k时刻的状态向量（n维）
F_k：状态转移矩阵（n×n）
B_k：控制输入矩阵（n×m）
u_k：控制输入向量（m维）
w_k：过程噪声，服从 N(0, Q_k)
z_k：观测向量（p维）
H_k：观测矩阵（p×n）
v_k：观测噪声，服从 N(0, R_k)
```

### 1.3 算法流程

**预测步骤（时间更新）**：
$$
\hat{x}_{k|k-1} = F_k \hat{x}_{k-1|k-1} + B_k u_k
$$

$$
P_{k|k-1} = F_k P_{k-1|k-1} F_k^T + Q_k
$$

```c++
1. 状态预测：x̂ₖ⁻ = F_k * x̂ₖ₋₁⁺ + B_k * u_k
2. 协方差预测：Pₖ⁻ = F_k * Pₖ₋₁⁺ * F_kᵀ + Q_k
```

**更新步骤（测量更新）**：
$$
K_k = P_{k|k-1} H_k^T (H_k P_{k|k-1} H_k^T + R_k)^{-1}
$$

$$
\hat{x}_{k|k} = \hat{x}_{k|k-1} + K_k (z_k - H_k \hat{x}_{k|k-1})
$$

$$
P_{k|k} = (I - K_k H_k) P_{k|k-1}
$$

```
3. 卡尔曼增益：Kₖ = Pₖ⁻ * H_kᵀ * (H_k * Pₖ⁻ * H_kᵀ + R_k)⁻¹
4. 状态更新：x̂ₖ⁺ = x̂ₖ⁻ + Kₖ * (z_k - H_k * x̂ₖ⁻)
5. 协方差更新：Pₖ⁺ = (I - Kₖ * H_k) * Pₖ⁻
```

------

### 1.4 代码分析

```c++
// 1. 初始化矩阵维度
F_.setIdentity(); // 单位阵

// 1. 更新状态转移矩阵 F (CV模型: p = p + v*dt)
    F_(0,2) = dt;
    F_(1,3) = dt;
```

假设状态向量为4维：`x = [px, py, vx, vy]^T`

对于匀速（Constant Velocity, CV）模型：

```
px_k = px_{k-1} + vx_{k-1} * dt
py_k = py_{k-1} + vy_{k-1} * dt
vx_k = vx_{k-1}
vy_k = vy_{k-1}
```

状态转移方程：`x_k = F * x_{k-1}`

其中F矩阵为：

```
F = [1, 0, dt, 0]
    [0, 1, 0,  dt]
    [0, 0, 1,  0]
    [0, 0, 0,  1]
```

### 1.5 过程噪声Q矩阵推导

```c++
// 3. 设置过程噪声 Q (表示物体可能会变加速，违背CV模型)
    // 使用离散白噪声模型
    double noise_ax = 5.0; // 假设最大加速度扰动 5m/s^2
    double noise_ay = 5.0;
    
    double dt_2 = dt * dt;
    double dt_3 = dt_2 * dt;
    double dt_4 = dt_3 * dt;

    Q_.setZero();
    Q_(0, 0) = dt_4 / 4 * noise_ax;
    Q_(0, 2) = dt_3 / 2 * noise_ax;
    Q_(1, 1) = dt_4 / 4 * noise_ay;
    Q_(1, 3) = dt_3 / 2 * noise_ay;
    Q_(2, 0) = dt_3 / 2 * noise_ax;
    Q_(2, 2) = dt_2 * noise_ax;
    Q_(3, 1) = dt_3 / 2 * noise_ay;
    Q_(3, 3) = dt_2 * noise_ay;
```

对于连续时间模型：

```
dx/dt = A * x + G * w
其中w是白噪声，协方差为Q_c
```

离散化后得到Q矩阵：

```
Q = ∫_0^dt e^{Aτ} G Q_c G^T e^{A^T τ} dτ
```

对于匀速模型，加速度噪声离散化为：

```
Q = [dt⁴/4 * σ_ax²,  0,         dt³/2 * σ_ax²,  0        ]
    [0,             dt⁴/4 * σ_ay²,  0,         dt³/2 * σ_ay²]
    [dt³/2 * σ_ax²,  0,         dt² * σ_ax²,    0        ]
    [0,             dt³/2 * σ_ay²,  0,         dt² * σ_ay²]
```

### 1.6 主要问题

**问题1：噪声参数使用错误**

```
double noise_ax = 5.0;  // 这是标准差，但Q公式需要方差
// 正确应为：
double var_ax = noise_ax * noise_ax;  // 25.0
```

**问题2：Q矩阵对称性**

Q矩阵应为对称矩阵，但代码中只设置了部分对称元素：

```
// 应设置Q(2,0) = Q(0,2)，但已设置
// 应设置Q(3,1) = Q(1,3)，但已设置
// 但还需要设置对称元素，不过Eigen会自动处理对称赋值
```

**问题3：噪声参数固定**

噪声参数硬编码，应可配置

 **推荐改进**

1. **修正噪声计算**：使用方差而非标准差
2. **参数可配置**：从配置文件读取噪声参数
3. **添加验证**：检查矩阵维度和数值范围
4. **增强鲁棒性**：添加异常处理和数值稳定性措施
5. **支持多模型**：扩展支持多种运动模型

------

# 扩展卡尔曼滤波

### 2.1 基本概念

**核心思想**：对非线性系统进行**一阶泰勒展开**，在估计点附近线性化

**适用系统**：

- 弱非线性系统
- **雅可比矩阵存在且可计算**
- 高斯噪声假设

### 2.2 数学模型

**非线性状态空间模型**：
$$
x_k = f(x_{k-1}, u_k) + w_k
$$

$$
z_k = h(x_k) + v_k
$$

```
状态方程：x_k = f(x_{k-1}, u_k) + w_k
观测方程：z_k = h(x_k) + v_k

其中：
f(·)：非线性状态转移函数
h(·)：非线性观测函数
```

**线性化过程**：

```
在估计点x̂处进行一阶泰勒展开：
f(x) ≈ f(x̂) + J_f(x̂)·(x - x̂)
h(x) ≈ h(x̂) + J_h(x̂)·(x - x̂)

其中：
J_f = ∂f/∂x：状态转移雅可比矩阵
J_h = ∂h/∂x：观测雅可比矩阵
```

### 2.3 算法流程

**预测步骤**：

```
1. 状态预测：x̂ₖ⁻ = f(x̂ₖ₋₁⁺, u_k)
2. 协方差预测：Pₖ⁻ = F_{k-1} * Pₖ₋₁⁺ * F_{k-1}ᵀ + Q_k
  其中：F_{k-1} = ∂f/∂x|_{x=x̂ₖ₋₁⁺}
```

**更新步骤**：

```
3. 卡尔曼增益：Kₖ = Pₖ⁻ * H_kᵀ * (H_k * Pₖ⁻ * H_kᵀ + R_k)⁻¹
  其中：H_k = ∂h/∂x|_{x=x̂ₖ⁻}
4. 状态更新：x̂ₖ⁺ = x̂ₖ⁻ + K_k * (z_k - h(x̂ₖ⁻))
5. 协方差更新：Pₖ⁺ = (I - K_k * H_k) * Pₖ⁻
```

### 2.4 优缺点分析

**优点**：

- 能处理非线性系统
- 相对UKF计算量小
- 在弱非线性系统中性能良好

**缺点**：

- 线性化误差（一阶近似）
- 雅可比矩阵计算复杂
- 强非线性系统性能差
- 可能发散（数值不稳定）

------

# 无迹卡尔曼滤波

### 3.1 基本概念

**核心思想**：无迹变换 (Unscented Transform, UT)

- 不使用线性化
- 选择一组Sigma点传播非线性函数
- 通过加权平均估计变换后的均值和协方差

**适用系统**：

- 强非线性系统
- 非线性程度高
- 需要更准确的协方差估计

### 3.2 无迹变换原理

**Sigma点选择**：

```
给定n维随机变量x，均值x̂，协方差P
选择2n+1个Sigma点：

χ⁰ = x̂
χⁱ = x̂ + (√((n+λ)P))_i, i=1,...,n
χⁱ = x̂ - (√((n+λ)P))_i, i=n+1,...,2n

其中：
λ = α²(n+κ) - n
α：控制Sigma点分布（通常0.001≤α≤1）
κ：次级缩放参数（通常0或3-n）
β：合并先验分布信息（高斯分布时β=2最优）
```

**权重计算**：

```
均值权重：
wₘ⁰ = λ/(n+λ)
wₘⁱ = 1/[2(n+λ)], i=1,...,2n

协方差权重：
w꜀⁰ = λ/(n+λ) + (1-α²+β)
w꜀ⁱ = 1/[2(n+λ)], i=1,...,2n
```

### 3.3 算法流程

**预测步骤**：

```
1. 生成Sigma点：χₖ₋₁ = [x̂ₖ₋₁⁺, x̂ₖ₋₁⁺ ± √((n+λ)Pₖ₋₁⁺)]
2. Sigma点通过状态转移函数：χₖ⁻ = f(χₖ₋₁, u_k)
3. 计算预测状态和协方差：
   x̂ₖ⁻ = Σ wₘⁱ χₖ⁻ⁱ
   Pₖ⁻ = Σ w꜀ⁱ (χₖ⁻ⁱ - x̂ₖ⁻)(χₖ⁻ⁱ - x̂ₖ⁻)ᵀ + Q_k
```

**更新步骤**：

```
4. Sigma点通过观测函数：Zₖ = h(χₖ⁻)
5. 计算预测观测和协方差：
   ẑₖ = Σ wₘⁱ Zₖⁱ
   Sₖ = Σ w꜀ⁱ (Zₖⁱ - ẑₖ)(Zₖⁱ - ẑₖ)ᵀ + R_k
   Cₖ = Σ w꜀ⁱ (χₖ⁻ⁱ - x̂ₖ⁻)(Zₖⁱ - ẑₖ)ᵀ
6. 计算卡尔曼增益：Kₖ = Cₖ Sₖ⁻¹
7. 状态更新：x̂ₖ⁺ = x̂ₖ⁻ + Kₖ (z_k - ẑₖ)
8. 协方差更新：Pₖ⁺ = Pₖ⁻ - Kₖ Sₖ Kₖᵀ
```

### 3.4 优缺点分析

**优点**：

- 能处理强非线性系统
- 无需计算雅可比矩阵
- 更准确的均值和协方差估计
- 二阶精度（EKF只有一阶）

**缺点**：

- 计算量较大（2n+1个Sigma点）
- 参数选择影响性能
- 协方差矩阵可能失去正定性
- 对非高斯分布效果有限